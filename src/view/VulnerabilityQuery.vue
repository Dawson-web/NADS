<script lang="ts" setup>
import { ElLoading } from "element-plus";
import { ref } from "vue";
import { useAssetStore } from "../store/asset";

let taskId = ref("");
let taskInfo = ref({});

let taskVisible = ref(false);
const assetStore = useAssetStore();

const doScan = async () => {
  const loading = ElLoading.service({
    lock: true,
    text: "任务执行中...",
    background: "rgba(0, 0, 0, 0.7)",
  });
  const res = await assetStore.scanVuln(taskId.value);
  taskVisible.value = true;
  let timer = setInterval(() => {
    if (res) {
      loading.close();
      clearInterval(timer);
    }
  }, 1000);
  getTaskInfo();
};
// 任务详情
const getTaskInfo = async () => {
  taskInfo.value = await assetStore.getTaskInfo(taskId.value);
  taskVisible.value = true;
};
</script>
<!-- vulnerability Query -->
<template>
  <div class="DetailedSearch">
    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      "
    >
      <h1 style="align-self: flex-start">漏洞查询:</h1>
      <el-input
        style="width: 500px"
        placeholder="请输入要执行的任务id"
        v-model="taskId"
      ></el-input>
      <div style="margin-top: 20px">
        <el-button class="el-button--add" @click="doScan()">执行</el-button>
        <el-button class="el-button--add" @click="getTaskInfo">详情</el-button>
      </div>
    </div>
    <el-collapse v-if="taskVisible" style="background-color: aquamarine">
      <el-collapse-item name="1">
        <template #title>
          <h3>任务:{{ taskInfo.name }}</h3>
        </template>
        <template #default>
          <P>任务创建人：{{ taskInfo.createBy }}</P>
          <P>创建时间：{{ taskInfo.createTime }}</P>
          <P>探测时间：{{ taskInfo.startTime }}~{{ taskInfo.endTime }}</P>
          <el-text class="mx-1" type="success"
            >状态：{{ taskInfo.status }}</el-text
          >
          <br />
          <el-text class="mx-1" type="primary"
            >类型：{{ taskInfo.type }}</el-text
          >
          <h2>漏洞信息：</h2>
          <div v-if="taskInfo.vulnerabilityDetailList">
            <p v-for="item in taskInfo.vulnerabilityDetailList">
              主机：{{ item.host }} 端口：{{ item.port }} 协议：{{
                item.protocol
              }}
              状态：{{ item.status }}
            </p>
          </div>
          <p v-else>未检测出漏洞</p>
        </template>
      </el-collapse-item>
    </el-collapse>
  </div>
</template>
<style scoped lang="scss">
.el-button--add {
  background-color: rgb(0, 203, 135);
  color: black;
}
</style>
